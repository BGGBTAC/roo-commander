# Roo Commander v5.2: Flexible Workflow Design

**Version:** 0.1
**Date:** 2025-04-05
**Status:** Draft
**Task ID:** TASK-TA-20250405-182800
**Authors:** Technical Architect

## 1. Introduction

This document details the design for the flexible workflow system in Roo Commander v5.2, addressing mode switching, context passing, `project_journal` persistence, and UI/UX considerations. It builds upon the concepts outlined in `project_journal/ideas/personas_and_flexible_workflows/flexible_workflow_concept.md` and requirements from `project_journal/planning/v5.2_project_plan.md` (Task 1.2).

The goal is to create a system that adapts to various user personas and workflows, allowing seamless transitions between different modes (tasks) while maintaining context and project history.

## 2. Core Mechanisms

### 2.1. Mode Switching

Mode switching is the primary mechanism for navigating the flexible workflow. It can be initiated in two ways:

*   **User-Initiated:** The user explicitly requests a mode switch using the existing `switch_mode` tool.
    *   `<switch_mode><mode_slug>...</mode_slug><reason>...</reason></switch_mode>`
    *   The `reason` parameter becomes more important for context passing (see 2.2).
*   **System-Suggested (Proactive Intent):** Based on the Proactive Intent analysis (detailed in Task 1.3 design), Roo Commander may suggest a relevant next mode.
    *   This suggestion will likely be presented using the `ask_followup_question` tool, offering the suggested mode switch as an option.
    *   Example Suggestion: "You've just created a new function. Would you like to switch to the `technical-writer` mode to document it?"
        *   `<suggest><switch_mode><mode_slug>technical-writer</mode_slug><reason>Documenting new function X</reason></switch_mode></suggest>` (Conceptual - actual implementation might differ)

### 2.2. Context Passing

Effective context passing is crucial for seamless transitions. When a mode switch occurs (either user-initiated or system-suggested/accepted), a structured context object will be passed to the incoming mode.

**Proposed Context Object Structure (JSON):**

```json
{
  "transition_id": "unique_uuid", // Optional: For tracing specific transitions
  "timestamp": "iso_timestamp",
  "source_mode_slug": "technical-architect", // Mode initiating the switch
  "target_mode_slug": "secretary", // Mode being switched to
  "trigger": "user_initiated" | "system_suggested", // How the switch was initiated
  "user_reason": "Optional user-provided reason from switch_mode", // User's stated goal
  "system_reason": "Optional system-generated reason for suggestion", // System's rationale
  "task_id": "TASK-TA-20250405-182800", // Current overarching task ID, if available
  "workflow_state": { // Optional: High-level state info
    "current_goal": "Design flexible workflow",
    "persona_hint": "Planner" // If identified
  },
  "relevant_files": [ // Files relevant to the transition context
    "project_journal/tasks/TASK-TA-20250405-182800.md",
    "project_journal/planning/v5.2_flexible_workflow_design.md" // Corrected path
  ],
  "previous_action_summary": "Drafted initial design doc content.", // Brief summary of last significant action
  "custom_data": {} // Mode-specific data payload (e.g., code snippet, specific entity ID)
}
```

**Passing Mechanism:** This context object will be made available to the newly activated mode as part of its initial state or environment details. The exact implementation depends on the core system architecture (Task 2.2).

### 2.3. `project_journal` Interaction & Persistence

The `project_journal` remains the central repository for persistent context, decisions, and history.

*   **Task Logs (`project_journal/tasks/`):** Continue to be the primary record for specific task progress, including mode transitions and key actions taken within a task context. The `Context Object` (specifically `task_id`, `previous_action_summary`) helps link actions back to the relevant log.
*   **Decision Records (`project_journal/decisions/`):** Significant architectural or workflow decisions made during a task should be captured here (potentially delegated via `secretary`).
*   **Planning Documents (`project_journal/planning/`):** Store high-level plans, requirements, and potentially persona mappings. Design documents like this one also belong here.
*   **Workflow State Snapshots (Potential New Structure):** Consider adding a dedicated section or file type within the journal (e.g., `project_journal/workflow_state/` or within `technical_notes/`) to periodically snapshot the `Context Object` or key parts of it, especially at significant decision points or before complex transitions. This aids in recovery and understanding long-running workflows. Needs further definition in Task 1.4 (`project_journal` Schema Updates).
*   **Mode Interaction:**
    *   **Passive Logging:** `Secretary` can be used (often via delegation) to append log entries, create/update documents, or potentially save state snapshots.
    *   **Active Contribution:** Modes like `Technical Architect`, `Project Manager`, `Technical Writer` actively create and manage structured content within the journal.
    *   **Context Reading:** Modes should be able to query/read relevant parts of the journal (e.g., current task goals, previous decisions) to inform their actions.

## 3. UI/UX Design for Flexible Workflow Guidance

This section details the proposed user interface (UI) and user experience (UX) elements to support the flexible workflow, addressing the points raised by the Technical Architect.

### 3.1. Mode Switch Suggestions

*   **Presentation:** System-suggested mode switches will be presented using the existing `ask_followup_question` tool. This maintains a consistent interaction pattern for user prompts.
*   **Clarity:** The prompt should clearly state the suggested mode and include the `system_reason` from the `Context Object` to provide transparency about why the suggestion is being made.
*   **User Control:** The user will always have the option to accept the suggestion (triggering the `switch_mode`) or decline and remain in the current mode.
*   **Conceptual Example (`ask_followup_question`):**
    ```xml
    &lt;ask_followup_question&gt;
    &lt;question&gt;Based on your recent action (e.g., "Created a new database schema"), the system suggests switching to the 'technical-writer' mode. Reason: To document the new schema design. Would you like to switch?&lt;/question&gt;
    &lt;follow_up&gt;
    &lt;suggest&gt;Yes, switch to 'technical-writer' to document schema.&lt;/suggest&gt;
    &lt;suggest&gt;No, stay in 'database-specialist' mode.&lt;/suggest&gt;
    &lt;/follow_up&gt;
    &lt;/ask_followup_question&gt;
    ```

### 3.2. Context Visibility

*   **"Workflow Context" Panel:** A dedicated UI panel, perhaps collapsible, will display key information from the `Context Object` passed during transitions.
*   **Default Summary View:** This view should be concise and provide essential context at a glance:
    *   `Current Task ID`: The active task identifier.
    *   `Transition`: Displaying `source_mode → target_mode`.
    *   `Trigger`: How the switch was initiated (`user_initiated` or `system_suggested`).
    *   `Reason`: The `user_reason` or `system_reason` provided.
    *   `Relevant Files`: A list of clickable links to files mentioned in `relevant_files`.
*   **Expandable Detailed View:** An option (e.g., an "Expand" button or toggle) should allow users to view the full, raw JSON `Context Object`. This is primarily for debugging, advanced users, or understanding the complete passed state.
*   **Conceptual Mockup (Text-based):**
    ```
    ┌───────────────────────────────────────────┐
    │ ▼ Workflow Context                        │
    ├───────────────────────────────────────────┤
    │ Task: TASK-TA-20250405-182800             │
    │ Transition: ui-designer → secretary       │
    │ Trigger: system_suggested                 │
    │ Reason: Log progress on design doc        │
    │ Files: [task_log.md] [design_doc.md]      │
    │                                [Expand 🔍]│
    └───────────────────────────────────────────┘
    ```
    *(Clicking [Expand 🔍] would reveal the full JSON object)*

### 3.3. Workflow Guidance

*   **Workflow Breadcrumbs:** Display a persistent but unobtrusive breadcrumb trail in the UI header or status bar, showing the sequence of the last 3-5 modes used within the current task context. This helps users orient themselves.
    *   Example: `... > 🏗️ technical-architect > 📝 secretary > 🎨 ui-designer (Current)`
*   **Persona/Goal Hints:** Subtle visual cues can reinforce the current context. This could include:
    *   Displaying the `current_goal` from the `workflow_state` near the mode title.
    *   Potentially using a small icon or color accent associated with the `persona_hint` (if available and clearly defined). These hints should be minimal to avoid clutter.
*   **Conceptual Mockup (UI Header Area):**
    ```
    ┌──────────────────────────────────────────────────────────────┐
    │ 🎨 UI Designer   | Goal: Design flexible workflow UI         │
    │ Path: ... > secretary > ui-designer                          │
    ├──────────────────────────────────────────────────────────────┤
    │ [Main Chat / Interaction Area]                               │
    └──────────────────────────────────────────────────────────────┘
    ```

### 3.4. `project_journal` Integration

*   **Easy File Access:** Files listed in `relevant_files` within the "Workflow Context" panel should be clickable links, allowing users to quickly open them in the editor.
*   **Streamlined Journaling Actions:** Introduce UI elements or commands to simplify common journaling tasks delegated to the `Secretary` mode:
    *   **`/log` command:** Could pre-fill a `new_task` call to `secretary` to append a message to the current `task_id`'s log file.
    *   **`/decide` command:** Could pre-fill a `new_task` call to `secretary` to create a new decision record in `project_journal/decisions/`.
    *   **UI Buttons (Optional):** Dedicated buttons like "Log Progress 📝" or "Record Decision 🤔" could provide a visual shortcut for these commands. Implementation depends on frontend capabilities.
*   **Conceptual Mockup (Input Area):**
    ```
    ┌───────────────────────────────────────────┐
    │ [Main Chat / Interaction Area]              │
    ├───────────────────────────────────────────┤
    │ [User Input Area...] [Send ➤] [Log 📝]    │
    └───────────────────────────────────────────┘
    ```

These designs aim to make the flexible workflow intuitive and informative without overwhelming the user. They provide necessary context, guide transitions, and integrate journaling smoothly.

## 4. Open Questions & Next Steps

*   Finalize the `Context Object` structure.
*   Define the exact mechanism for passing the context object to modes (Core System Task 2.2).
*   Refine `project_journal` schema for state persistence (Task 1.4).
*   Collaborate with `UI Designer` on UI/UX elements (Task 1.2 - UID Lead).
*   Integrate with Proactive Intent design (Task 1.3).
*   Consider error handling for failed transitions or context passing.