# Design Document: Proactive Intent Logic & Confidence Scoring (v5.2)

**Version:** 1.0
**Date:** 2025-04-05
**Task ID:** TASK-TA-20250405-183700
**Author:** Technical Architect Mode
**Status:** Proposed

## 1. Introduction

This document outlines the proposed design for the proactive intent analysis and confidence scoring mechanism within the `roo-commander` mode. The goal is to interpret the user's initial message to determine the most appropriate next step, aligning with the interaction paths (A-E) defined in `project_journal/ideas/personas_and_flexible_workflows/proactive_intent_roo_commander.md`.

## 2. Design Goals

*   **Prioritize Directives:** Explicit user commands (mode switching, requesting options) should bypass complex analysis.
*   **Effective Intent Mapping:** Map user requests to relevant personas/workflows defined in `project_journal/planning/v5.2_persona_mode_mapping.md` when no direct command is given.
*   **Confidence-Based Guidance:** Provide suggestions based on the confidence level of the intent analysis (High, Medium, Low).
*   **User Control:** Ensure users can always override suggestions or choose alternative paths.
*   **Initial Simplicity:** Start with a manageable keyword-based approach, focusing on the initial user message. Contextual analysis (workspace state) can be a future enhancement.

## 3. Proposed Logic Flow

The following steps will be executed upon receiving the user's initial message in `roo-commander`:

1.  **Input:** User's raw initial message string.
2.  **Preprocessing:** Convert the message to lowercase for case-insensitive matching. Optional: Remove common punctuation.
3.  **Path A Check (Direct Mode Request):**
    *   **Mechanism:** Scan the preprocessed message for keywords explicitly matching known mode slugs, names, or predefined aliases (e.g., "code", "git manager", "technical architect", "fixer", "pm", "init"). Maintain a list of modes and their aliases.
    *   **Action:** If a clear match is found, trigger **Path A**. Prepare to use `<switch_mode>` or delegate the task directly to the identified mode.
    *   **Confidence:** N/A (Direct command).
    *   **Proceed to Step 6.**
4.  **Path B Check (Request for Options):**
    *   **Mechanism:** If Path A did not trigger, scan the preprocessed message for keywords indicating a request for options or help (e.g., "list", "options", "help", "what can you do", "show modes", "modes?").
    *   **Action:** If a match is found, trigger **Path B**. Prepare to use `<ask_followup_question>` presenting a categorized list of common starting modes/workflows (as per `proactive_intent_roo_commander.md` example).
    *   **Confidence:** N/A (Direct command).
    *   **Proceed to Step 6.**
5.  **Path C/D/E Intent Analysis & Confidence Scoring (If Paths A & B fail):**
    *   **5.1 Keyword Extraction & Persona Scoring:**
        *   Define a dictionary mapping keywords/phrases to associated personas and assigning weights (higher weight for stronger indicators). This mapping should be derived from `v5.2_persona_mode_mapping.md`.
            *   *Example Weights:* `{"fix": {"Fixer": 2}, "bug": {"Fixer": 3}, "error": {"Fixer": 2}, "design": {"Planner": 2, "Explorer": 1, "Technical Architect": 2}, "plan": {"Planner": 2, "Project Manager": 2}, "new project": {"Planner": 1, "Vibe Coder": 1, "Project Initializer": 2}, "create": {"Vibe Coder": 1, "Prototyper": 1}, "refactor": {"Refactor Specialist": 3, "Adopter": 1}, "document": {"Documenter": 3, "Technical Writer": 3}, "learn": {"Learner": 3}, "explore": {"Explorer": 2, "Brainstormer": 2}, "prototype": {"Prototyper": 3}, "api": {"API Developer": 2, "Planner": 1, "Fixer": 1}, "ui": {"Frontend Developer": 2, "UI Designer": 2}, "database": {"Database Specialist": 2}}` (This needs refinement and expansion).
        *   Initialize scores for all relevant personas to zero.
        *   Iterate through the preprocessed user message, identifying keywords present in the mapping dictionary.
        *   For each matched keyword, add its associated weight(s) to the corresponding persona score(s).
    *   **5.2 Confidence Calculation & Ambiguity Check:**
        *   Identify the persona with the highest score (`top_persona`, `max_score`).
        *   Identify the persona with the second highest score (`second_persona`, `second_score`). Handle cases with only one or zero matching personas.
        *   Define Confidence Thresholds (Initial estimates, subject to tuning):
            *   `HIGH_CONFIDENCE_THRESHOLD = 5`
            *   `MEDIUM_CONFIDENCE_THRESHOLD = 2`
            *   `AMBIGUITY_DIFFERENCE = 2`
        *   Determine Confidence Level:
            *   If `max_score >= HIGH_CONFIDENCE_THRESHOLD` AND (`second_score` is null OR `max_score - second_score >= AMBIGUITY_DIFFERENCE`): **Confidence = High**
            *   Else if `max_score >= MEDIUM_CONFIDENCE_THRESHOLD`: **Confidence = Medium**
            *   Else: **Confidence = Low**
        *   *Note:* If `max_score` is high but very close to `second_score`, treat it as Medium confidence due to ambiguity.
    *   **5.3 Path Determination:**
        *   **High Confidence:** Trigger **Path C**. Identify the primary mode(s) associated with `top_persona` (from `v5.2_persona_mode_mapping.md`). Prepare `<ask_followup_question>` proposing this mode/workflow.
        *   **Medium Confidence:** Trigger **Path D**. Identify primary modes for `top_persona` and potentially `second_persona`. Prepare `<ask_followup_question>` offering these options or a clarifying question based on the ambiguity.
        *   **Low Confidence:** Trigger **Path E**. Prepare a response stating uncertainty and offering generic starting points (similar to Path B) via `<ask_followup_question>`.
6.  **Output:** The determined Path (A-E), and the necessary information for the corresponding action (e.g., target mode for Path A, suggestions for `ask_followup_question` for Paths B-E).

## 4. Data Structures

*   **Mode Alias Map:** `Map<String, String>` (Alias -> Mode Slug) - For Path A matching.
*   **Keyword-Persona Weight Map:** `Map<String, Map<PersonaEnum, Integer>>` - For scoring in Step 5.1.
*   **Persona-Mode Map:** `Map<PersonaEnum, List<ModeSlug>>` - To suggest modes based on scored persona (derived from `v5.2_persona_mode_mapping.md`).

## 5. Non-Functional Considerations

*   **Performance:** The keyword matching and scoring should be computationally inexpensive for near-instantaneous response.
*   **Maintainability:** The keyword maps and persona mappings should be easily configurable and updatable as modes and understanding evolve. Consider storing these in configuration files.
*   **Tunability:** Confidence thresholds and keyword weights will likely require tuning based on real-world usage and feedback.

## 6. Future Enhancements

*   **Contextual Analysis:** Incorporate workspace context (open files, git status, project type detection) into the scoring.
*   **NLP/ML Models:** Explore more sophisticated intent recognition models for higher accuracy, potentially using embeddings or classifiers.
*   **User Feedback Loop:** Allow users to correct misinterpretations, feeding back into the model/heuristics tuning.
*   **Multi-turn Analysis:** Extend analysis beyond the first message if initial intent is unclear.

## 7. Risks & Mitigation

*   **Risk:** Poor keyword mapping leads to inaccurate intent detection.
    *   **Mitigation:** Iteratively refine keyword lists and weights based on testing and user feedback. Ensure robust fallback paths (D & E).
*   **Risk:** Overly complex logic becomes hard to maintain or debug.
    *   **Mitigation:** Start simple (keyword-based) and incrementally add complexity. Ensure clear separation of concerns in implementation.
*   **Risk:** False positives in Path A/B prevent useful intent analysis.
    *   **Mitigation:** Carefully define mode aliases and option-request keywords to minimize accidental matches.