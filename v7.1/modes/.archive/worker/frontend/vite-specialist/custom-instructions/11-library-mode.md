# 11. Library Mode (`build.lib`)

Using Vite to bundle JavaScript or TypeScript code as a distributable library.

## Core Concept: Building Libraries, Not Apps

While Vite is excellent for building applications, it also includes a "Library Mode" specifically designed for bundling libraries intended for consumption by other projects.

**Key Differences from App Mode:**

*   **Entry Point:** Instead of an `index.html` file, the entry point is typically a JavaScript/TypeScript file (e.g., `src/main.ts`).
*   **Output Formats:** Libraries often need to be distributed in multiple module formats (like ESM and UMD) for compatibility.
*   **External Dependencies:** Dependencies (`react`, `vue`, etc.) that the consuming application is expected to provide are usually *externalized* (not included in the library bundle) to avoid duplication and bloat. Vite externalizes most dependencies by default in library mode.
*   **CSS Handling:** CSS can be injected into the JavaScript bundle (as strings), emitted as a separate file, or handled differently based on configuration.

## Configuration (`build.lib` in `vite.config.js`/`ts`)

Library mode is configured using the `build.lib` option.

```typescript
// vite.config.ts
import { defineConfig } from 'vite';
import path from 'path';
import react from '@vitejs/plugin-react'; // Example if your library uses React
// import dts from 'vite-plugin-dts'; // Example plugin to generate .d.ts files

export default defineConfig({
  plugins: [
    react(),
    // dts({ insertTypesEntry: true }), // Generate declaration files
  ],
  build: {
    // --- Library Mode Configuration ---
    lib: {
      // Entry point for the library (e.g., where you export your components/functions)
      entry: path.resolve(__dirname, 'src/lib/main.ts'),

      // Name for the UMD build (used for global variable if no module system is used)
      name: 'MyAwesomeLib',

      // Output formats (e.g., 'es', 'umd', 'cjs', 'iife')
      formats: ['es', 'umd'], // Common choice: ES Module and UMD

      // Output filename (can be a function to customize based on format)
      // Default based on package.json name if not specified
      fileName: (format) => `my-awesome-lib.${format}.js`,
    },

    // --- Rollup Options (Crucial for Library Mode) ---
    rollupOptions: {
      // --- External Dependencies ---
      // Specify dependencies that should NOT be bundled into your library.
      // These are expected to be provided by the consuming application.
      // Vite externalizes most dependencies by default, but be explicit for clarity.
      external: ['react', 'react-dom', /^@mui\/.*/], // Example: Externalize React and MUI

      // --- UMD Build Specifics ---
      output: {
        // Provide global variables to use in the UMD build
        // for externalized deps (browser environment)
        globals: {
          react: 'React', // 'import react from "react"' -> global variable 'React'
          'react-dom': 'ReactDOM',
          // '@mui/material': 'MaterialUI', // Example for MUI
        },
        // Optional: Extend default Rollup output options if needed
        // assetFileNames: 'assets/[name].[ext]',
      },
    },

    // --- Other Build Options ---
    sourcemap: true, // Generate source maps for easier debugging
    // emptyOutDir: true, // Usually true, but might be false if merging output
    outDir: 'dist/lib', // Specify library output directory
  },
  // ... other config like resolve.alias
});
```

## `package.json` Configuration for Libraries

Ensure your `package.json` is correctly configured for publishing:

*   **`name`:** The name of your library package.
*   **`version`:** The library version.
*   **`main`:** Entry point for CommonJS environments (often points to the UMD or CJS build).
    *   `"main": "./dist/lib/my-awesome-lib.umd.js"`
*   **`module`:** Entry point for ESM-aware tools (points to the ES build).
    *   `"module": "./dist/lib/my-awesome-lib.es.js"`
*   **`exports`:** (Recommended) Provides more fine-grained control over module resolution for different environments.
    ```json
    "exports": {
      ".": {
        "import": "./dist/lib/my-awesome-lib.es.js",
        "require": "./dist/lib/my-awesome-lib.umd.js"
      },
      "./style.css": "./dist/lib/style.css" // Example if CSS is separate
    },
    ```
*   **`types`:** Path to the main declaration file (`.d.ts`) generated by `tsc` or a plugin like `vite-plugin-dts`.
    *   `"types": "./dist/lib/main.d.ts"`
*   **`files`:** Array of files/directories to include when the package is published.
    *   `"files": ["dist/lib", "README.md"]`
*   **`peerDependencies`:** List dependencies the consuming application *must* provide (e.g., `react`, `react-dom`). This prevents version conflicts.
    ```json
    "peerDependencies": {
      "react": "^18.0.0",
      "react-dom": "^18.0.0"
    }
    ```
*   **`scripts`:** Include a build script using `vite build`.
    *   `"build": "vite build && tsc --emitDeclarationOnly"` (if generating types separately)

Vite's library mode simplifies the process of bundling libraries for distribution. Configure `build.lib` for entry and formats, use `build.rollupOptions.external` to exclude peer dependencies, and ensure your `package.json` correctly defines the entry points (`main`, `module`, `exports`, `types`) and `peerDependencies`.

*(Refer to the official Vite documentation on Library Mode.)*