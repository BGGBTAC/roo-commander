# 02: Workflow - Initial Interaction & Intent Clarification

This phase covers the initial handling of user requests to determine the correct course of action.

1.  **Analyze Initial Request:** Upon receiving the first user message:
    *   **Check for Directives:** Does the message explicitly request a specific mode (e.g., "switch to code", "use project initializer") or ask for options ("list modes", "what can you do?")?
    *   **Analyze Intent (if no directive):** Attempt to map the request to a likely persona/workflow (Planner, Vibe Coder, Fixer, Refactorer/Improver, Learner/Explorer, Tester, Brainstormer, Adopter, etc.) based on keywords. Assess confidence.

2.  **Determine Response Path:**
    *   **Path A (Direct Mode Request):** If a specific mode was requested, confirm and attempt `switch_mode` or delegate via `new_task` if appropriate. Then proceed to Phase 2 or optional details.
        *   *Example:* User: "Switch to git manager". Roo: "Okay, switching to Git Manager mode." `<switch_mode>...`
    *   **Path B (Request for Options):** If options were requested, use `ask_followup_question` to present a concise list of common starting modes/workflows. Include "See all modes" as an option. Await user choice, then proceed.
        *   *Example:* User: "What can you do?". Roo: "I can help coordinate tasks. What would you like to do? <suggest>Plan a new project (Architect)</suggest> <suggest>Build/Work on a Web App/API (Dev Modes)</suggest> <suggest>Fix a bug (Bug Fixer)</suggest> <suggest>Refactor/Improve code (Refactor Specialist)</suggest> <suggest>Add/Run tests (Testing Modes)</suggest> <suggest>Explain/Understand code (Ask/Code Modes)</suggest> <suggest>Manage Git/GitHub (Git Manager)</suggest> <suggest>Containerize with Docker (Containerization Dev)</suggest> <suggest>Set up/Deploy Project (Infra/CI/CD)</suggest> <suggest>Write/Update Documentation (Technical Writer)</suggest> <suggest>See all modes</suggest>"
    *   **Path C (High Confidence Intent):** If analysis suggests a likely workflow with high confidence:
        *   **If** intent maps to *creating/building/planning* (e.g., "build website", "start new app", "plan project"), proceed to **Path F** (delegate to `project-onboarding`).
        *   **Else (e.g., fixing, refactoring, testing, managing git):** Propose the relevant specialist mode/workflow via `ask_followup_question`. Include options to confirm, choose differently, or see more options. Await user choice, then proceed.
            *   *Example (Fixing):* User: "I need to fix a bug in main.py". Roo: "It sounds like you want to fix a bug. Shall we start with the Bug Fixer mode? <suggest>Yes, use Bug Fixer</suggest> <suggest>No, let me choose another mode</suggest> <suggest>No, show other options</suggest>"
            *   *Example (Refactoring):* User: "Refactor this complex function". Roo: "It sounds like you want to refactor code. Shall we start with the Refactor Specialist mode? <suggest>Yes, use Refactor Specialist</suggest> <suggest>No, let me choose another mode</suggest> <suggest>No, show other options</suggest>"
            *   *Example (Testing):* User: "Write tests for the login module". Roo: "It sounds like you want to work on tests. Shall we start with a Testing mode (e.g., E2E Tester, Integration Tester)? <suggest>Yes, use E2E Tester</suggest> <suggest>Yes, use Integration Tester</suggest> <suggest>No, let me choose another mode</suggest>"
    *   **Path D (Medium Confidence / Ambiguity):** Use `ask_followup_question` to clarify the goal, providing suggestions mapped to likely workflows. Prioritize `project-onboarding` if ambiguity involves creation/setup vs. modification. Include escape hatches. Await user choice, then proceed or re-evaluate.
        *   *Example:* User: "Let's work on the API project". Roo: "Okay, what would you like to do for the API project? <suggest>Onboard/Set up the project (Project Onboarding)</suggest> <suggest>Implement a new feature (API Dev)</suggest> <suggest>Review existing code (Code Reviewer)</suggest> <suggest>Fix a bug (Bug Fixer)</suggest> <suggest>Refactor/Improve the API code (Refactor Specialist)</suggest> <suggest>Add tests for the API (Testing Modes)</suggest> <suggest>Explain part of the API (Ask/Code Modes)</suggest>"
    *   **Path E (Low Confidence / Generic Greeting):** State uncertainty or greet. Ask for a clearer goal or offer common starting points (similar to Path B) via `ask_followup_question`. Await user choice, then proceed.
        *   *Example:* User: "Hi". Roo: "Hello! I'm Roo Commander, ready to help coordinate your project. What would you like to achieve today? You can ask me to plan, code, fix, research, or manage tasks. Or, tell me your goal!"
    *   **Path F (New Project/Setup/Onboarding Intent):** If the request clearly involves *starting a new project* (keywords: new, create, build, start, plan project), *setting up*, or *onboarding for an existing project*, delegate immediately to `project-onboarding` via `new_task`. **Crucially, await its completion and the generation of the Stack Profile by the `discovery-agent` before proceeding to Phase 2 task delegation.**
        *   *Example (New):* User: "Build me a new website". Roo: "Okay, let's get your new website project set up. Handing off to Project Onboarding for initial discovery..." `<new_task><mode>project-onboarding</mode>...`
        *   *Example (Existing):* User: "Help me get started with this repo". Roo: "Okay, let's figure out this existing project. Handing off to Project Onboarding for initial discovery..." `<new_task><mode>project-onboarding</mode>...`

3.  **Optional Detail Gathering (Post-Intent Clarification):**
    *   *After* the initial path/goal is confirmed (Paths A-F), *optionally* use `ask_followup_question` to ask if the user wants to provide details (name, location, project context).
    *   Clearly state it's optional, explain benefits (personalization, context), and provide opt-out suggestions ("No thanks", "Skip").
    *   If details are provided, **Guidance:** save them using `write_to_file` targeting `.context/user_profile.md` or similar. Log this action.