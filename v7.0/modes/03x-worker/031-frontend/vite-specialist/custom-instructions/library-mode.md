# Vite: Library Mode (`build.lib`)

Using Vite to build and bundle libraries (e.g., components, utilities) for distribution.

## Core Concept

Vite can be configured to output library bundles suitable for publishing to NPM or direct use in other projects, instead of building a full application. This is controlled via the `build.lib` option in `vite.config.js`/`ts`.

## Configuration (`vite.config.js`/`ts`)

*   **`build.lib`:** An object specifying library build options.
    *   `entry`: (Required) Path to the library's entry point file (e.g., `src/main.ts`, `src/index.js`). Can also be an object for multiple entry points.
    *   `name`: (Required) UMD/IIFE global variable name for the library.
    *   `formats`: (Optional) Array of output formats (`'es'`, `'umd'`, `'iife'`, `'cjs'`). Default is `['es', 'umd']`.
    *   `fileName`: (Optional) Function or string to customize the output filename. Defaults based on format and name.
*   **`build.rollupOptions`:** Used to configure Rollup options, especially for externalizing dependencies.
    *   `external`: Array of dependency names (e.g., `'react'`, `'vue'`) that should **not** be bundled into your library. These are expected to be provided by the consuming application.
    *   `output.globals`: (Required for UMD/IIFE) Maps external dependency IDs to global variable names (e.g., `{ react: 'React', vue: 'Vue' }`).

```typescript
// vite.config.ts (Library Mode Example)
import { defineConfig } from 'vite';
import path from 'node:path';
import react from '@vitejs/plugin-react'; // Example for a React component library
import dts from 'vite-plugin-dts'; // Plugin to generate .d.ts files

export default defineConfig({
  plugins: [
    react(),
    dts({ // Generate declaration files (*.d.ts)
      insertTypesEntry: true, // Create a single types entry point
    }),
  ],
  build: {
    // Library Mode configuration
    lib: {
      entry: path.resolve(__dirname, 'src/index.ts'), // Path to library entry point
      name: 'MyAwesomeLibrary', // Global variable name for UMD/IIFE builds
      formats: ['es', 'umd'], // Output formats (ES Module, Universal Module Definition)
      fileName: (format) => `my-awesome-library.${format}.js`, // Custom output file names
    },
    // Rollup configuration
    rollupOptions: {
      // Externalize peer dependencies (React in this case)
      external: ['react', 'react-dom', 'react/jsx-runtime'],
      output: {
        // Global variables for UMD build (for externalized deps)
        globals: {
          react: 'React',
          'react-dom': 'ReactDOM',
          'react/jsx-runtime': 'jsxRuntime', // Adjust based on actual global if needed
        },
      },
    },
    sourcemap: true, // Generate source maps for debugging
    emptyOutDir: true, // Clean output directory before build
  },
});
```

## `package.json` Configuration

Configure your `package.json` correctly for publishing:

*   **`name`**, **`version`**, **`description`**, **`author`**, **`license`**, **`repository`**, **`keywords`**: Standard NPM package fields.
*   **`type`**: Set to `"module"` if your primary output (`main` or `exports`) is ES Module format.
*   **`main`**: Path to the primary entry point (often UMD or CJS for broader compatibility).
*   **`module`**: Path to the ES Module entry point.
*   **`exports`**: (Recommended) Provides fine-grained control over module resolution for different environments (import vs require, types).
*   **`types`** or **`typings`**: Path to the main declaration file (`.d.ts`) generated by `tsc` or `vite-plugin-dts`.
*   **`files`**: Array of files/directories to include when publishing to NPM (e.g., `["dist", "README.md"]`). Ensure your build output (`dist` or `build.outDir`) is included.
*   **`peerDependencies`**: List dependencies expected to be provided by the consuming application (e.g., `react`, `vue`). These should match the `external` array in `rollupOptions`.
*   **`scripts`**: Include a build script (e.g., `"build": "tsc && vite build"`).

```json
// package.json (Library Example)
{
  "name": "my-awesome-library",
  "version": "1.0.0",
  "description": "An awesome library built with Vite.",
  "type": "module", // Indicate primary output is ESM
  "main": "./dist/my-awesome-library.umd.js", // UMD entry point
  "module": "./dist/my-awesome-library.es.js", // ESM entry point
  "types": "./dist/index.d.ts", // Main type declaration file
  "exports": {
    ".": {
      "import": "./dist/my-awesome-library.es.js",
      "require": "./dist/my-awesome-library.umd.js",
      "types": "./dist/index.d.ts"
    }
  },
  "files": [
    "dist" // Include the build output directory
  ],
  "scripts": {
    // Run tsc for type checking/declaration emit (if not using vite-plugin-dts) then vite build
    "build": "vite build",
    // Or if using tsc for declarations: "build": "tsc && vite build"
    "dev": "vite"
  },
  "peerDependencies": {
    "react": "^18.0.0", // Example peer dependency
    "react-dom": "^18.0.0"
  },
  "devDependencies": {
    "@types/react": "^18.0.0",
    "@types/react-dom": "^18.0.0",
    "@vitejs/plugin-react": "^4.0.0",
    "react": "^18.0.0",
    "react-dom": "^18.0.0",
    "typescript": "^5.0.0",
    "vite": "^5.0.0",
    "vite-plugin-dts": "^3.0.0" // Example plugin for .d.ts generation
  }
}
```

## Considerations

*   **External Dependencies:** Carefully decide which dependencies should be `external` (peer dependencies) vs. bundled directly into your library. Frameworks (React, Vue) and large utility libraries are usually externalized.
*   **CSS:** How CSS is handled depends on your library. You can bundle it into the JS (default), extract it to a separate file (`build.cssCodeSplit: true`), or handle it via CSS Modules. Consider the implications for consumers.
*   **Type Declarations:** Ensure you generate and include correct TypeScript declaration files (`.d.ts`) for your library users. Use `tsc --emitDeclarationOnly` or plugins like `vite-plugin-dts`.

*(Refer to the official Vite Library Mode documentation: https://vitejs.dev/guide/build.html#library-mode)*