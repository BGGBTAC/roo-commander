# MUI Integration with Next.js

Patterns for setting up MUI (v5+) with Next.js App Router and Pages Router, ensuring compatibility with Server-Side Rendering (SSR) and styling.

## 1. Next.js App Router (Recommended)

*   **Key Challenge:** Ensuring styles generated by Emotion (MUI's default engine) on the server are correctly injected and hydrated on the client without mismatches.
*   **Solution:** Use a client component (`ThemeRegistry`) to configure the theme provider and handle style injection during SSR.

**Steps:**

1.  **Install Dependencies:**
    ```bash
    npm install @mui/material @emotion/react @emotion/styled
    # Or for Joy UI:
    # npm install @mui/joy @emotion/react @emotion/styled
    ```
2.  **Create `ThemeRegistry.tsx`:** Create a client component to manage theme setup and style injection.
    ```tsx
    // src/components/ThemeRegistry/ThemeRegistry.tsx
    'use client'; // Mark as a Client Component

    import * as React from 'react';
    import { ThemeProvider } from '@mui/material/styles';
    import CssBaseline from '@mui/material/CssBaseline';
    import NextAppDirEmotionCacheProvider from './EmotionCache';
    import theme from './theme'; // Your custom theme (createTheme)

    // Or for Joy UI:
    // import { CssVarsProvider, extendTheme } from '@mui/joy/styles';
    // import CssBaseline from '@mui/joy/CssBaseline';
    // import NextAppDirEmotionCacheProvider from './EmotionCache';
    // import theme from './theme'; // Your custom theme (extendTheme)
    // import { getInitColorSchemeScript } from '@mui/joy/styles';


    export default function ThemeRegistry({ children }: { children: React.ReactNode }) {
      return (
        <NextAppDirEmotionCacheProvider options={{ key: 'mui' }}> {/* or 'joy' */}
          {/* --- MUI Core Setup --- */}
          <ThemeProvider theme={theme}>
            {/* CssBaseline kickstarts an elegant, consistent, and simple baseline to build upon. */}
            <CssBaseline />
            {children}
          </ThemeProvider>

          {/* --- Joy UI Setup --- */}
          {/* <CssVarsProvider theme={theme} defaultMode="system"> */}
            {/* CssBaseline kickstarts an elegant, consistent, and simple baseline to build upon. */}
            {/* <CssBaseline /> */}
            {/* {getInitColorSchemeScript()} {/* Optional: for preventing FOUC with dark/system mode */}
            {/* {children} */}
          {/* </CssVarsProvider> */}
        </NextAppDirEmotionCacheProvider>
      );
    }
    ```
3.  **Create `EmotionCache.tsx`:** Helper component for managing Emotion's cache during SSR.
    ```tsx
    // src/components/ThemeRegistry/EmotionCache.tsx
    'use client';
    import * as React from 'react';
    import createCache from '@emotion/cache';
    import { useServerInsertedHTML } from 'next/navigation';
    import { CacheProvider as DefaultCacheProvider } from '@emotion/react';
    import type { EmotionCache, Options as CacheOptions } from '@emotion/cache';

    export type NextAppDirEmotionCacheProviderProps = {
      options: Omit<CacheOptions, 'insertionPoint'>;
      CacheProvider?: (props: {
        value: EmotionCache;
        children: React.ReactNode;
      }) => React.JSX.Element | null;
      children: React.ReactNode;
    };

    export default function NextAppDirEmotionCacheProvider(props: NextAppDirEmotionCacheProviderProps) {
      const { options, CacheProvider = DefaultCacheProvider, children } = props;

      const [registry] = React.useState(() => {
        const cache = createCache(options);
        cache.compat = true;
        const prevInsert = cache.insert;
        let inserted: { name: string; isGlobal: boolean }[] = [];
        cache.insert = (...args) => {
          const [selector, serialized] = args;
          if (cache.inserted[serialized.name] === undefined) {
            inserted.push({ name: serialized.name, isGlobal: !selector });
          }
          return prevInsert(...args);
        };
        const flush = () => {
          const prevInserted = inserted;
          inserted = [];
          return prevInserted;
        };
        return { cache, flush };
      });

      useServerInsertedHTML(() => {
        const inserted = registry.flush();
        if (inserted.length === 0) {
          return null;
        }
        let styles = '';
        let dataEmotionAttribute = registry.cache.key;

        const globals: { name: string; style: string }[] = [];

        inserted.forEach(({ name, isGlobal }) => {
          const style = registry.cache.inserted[name];

          if (typeof style !== 'boolean') {
            if (isGlobal) {
              globals.push({ name, style });
            } else {
              styles += style;
              dataEmotionAttribute += ` ${name}`;
            }
          }
        });

        return (
          <React.Fragment>
            {globals.map(({ name, style }) => (
              <style
                key={name}
                data-emotion={`${registry.cache.key}-global ${name}`}
                dangerouslySetInnerHTML={{ __html: style }}
              />
            ))}
            {styles && (
              <style
                data-emotion={dataEmotionAttribute}
                dangerouslySetInnerHTML={{ __html: styles }}
              />
            )}
          </React.Fragment>
        );
      });

      return <CacheProvider value={registry.cache}>{children}</CacheProvider>;
    }
    ```
4.  **Create `theme.ts`:** Define your custom theme using `createTheme` (Core) or `extendTheme` (Joy).
5.  **Apply in Root Layout:** Import and use `ThemeRegistry` in your root layout (`src/app/layout.tsx`).
    ```tsx
    // src/app/layout.tsx
    import * as React from 'react';
    import ThemeRegistry from '@/components/ThemeRegistry/ThemeRegistry'; // Adjust path

    export default function RootLayout({ children }: { children: React.ReactNode }) {
      return (
        <html lang="en">
          <body>
            <ThemeRegistry>{children}</ThemeRegistry>
          </body>
        </html>
      );
    }
    ```

## 2. Next.js Pages Router

*   **Key Challenge:** Similar to App Router, ensuring server-rendered styles match client-side hydration.
*   **Solution:** Override `_app.js` and `_document.js`.

**Steps:**

1.  **Install Dependencies:** (Same as App Router)
2.  **Create `theme.ts`:** (Same as App Router)
3.  **Modify `_app.js` (or `.tsx`):** Wrap the `Component` with `ThemeProvider` and `CssBaseline`. Inject Emotion's cache.
    ```jsx
    // pages/_app.js
    import * as React from 'react';
    import PropTypes from 'prop-types';
    import Head from 'next/head';
    import { ThemeProvider } from '@mui/material/styles';
    import CssBaseline from '@mui/material/CssBaseline';
    import { CacheProvider } from '@emotion/react';
    import theme from '../src/theme'; // Adjust path
    import createEmotionCache from '../src/createEmotionCache'; // Helper function

    // Client-side cache, shared for the whole session of the user in the browser.
    const clientSideEmotionCache = createEmotionCache();

    export default function MyApp(props) {
      const { Component, emotionCache = clientSideEmotionCache, pageProps } = props;

      return (
        <CacheProvider value={emotionCache}>
          <Head>
            <meta name="viewport" content="initial-scale=1, width=device-width" />
          </Head>
          <ThemeProvider theme={theme}>
            {/* CssBaseline kickstarts an elegant, consistent, and simple baseline to build upon. */}
            <CssBaseline />
            <Component {...pageProps} />
          </ThemeProvider>
        </CacheProvider>
      );
    }
    // ... PropTypes definition ...
    ```
4.  **Create `createEmotionCache.js`:** Helper to create Emotion cache.
    ```javascript
    // src/createEmotionCache.js
    import createCache from '@emotion/cache';

    export default function createEmotionCache() {
      return createCache({ key: 'css', prepend: true });
    }
    ```
5.  **Modify `_document.js` (or `.tsx`):** Inject server-side generated styles into the `<head>`.
    ```jsx
    // pages/_document.js
    import * as React from 'react';
    import Document, { Html, Head, Main, NextScript } from 'next/document';
    import createEmotionServer from '@emotion/server/create-instance';
    import theme from '../src/theme'; // Adjust path
    import createEmotionCache from '../src/createEmotionCache'; // Adjust path

    export default class MyDocument extends Document {
      render() {
        return (
          <Html lang="en">
            <Head>
              {/* PWA primary color */}
              <meta name="theme-color" content={theme.palette.primary.main} />
              <link rel="shortcut icon" href="/favicon.ico" />
              <meta name="emotion-insertion-point" content="" />
              {this.props.emotionStyleTags}
            </Head>
            <body>
              <Main />
              <NextScript />
            </body>
          </Html>
        );
      }
    }

    // `getInitialProps` belongs to `_document` (instead of `_app`),
    // it's compatible with static-site generation (SSG).
    MyDocument.getInitialProps = async (ctx) => {
      // ... (Standard MUI _document setup - copy from MUI docs) ...
      const originalRenderPage = ctx.renderPage;
      const cache = createEmotionCache();
      const { extractCriticalToChunks } = createEmotionServer(cache);

      ctx.renderPage = () =>
        originalRenderPage({
          enhanceApp: (App) =>
            function EnhanceApp(props) {
              return <App emotionCache={cache} {...props} />;
            },
        });

      const initialProps = await Document.getInitialProps(ctx);
      const emotionStyles = extractCriticalToChunks(initialProps.html);
      const emotionStyleTags = emotionStyles.styles.map((style) => (
        <style
          data-emotion={`${style.key} ${style.ids.join(' ')}`}
          key={style.key}
          dangerouslySetInnerHTML={{ __html: style.css }}
        />
      ));

      return {
        ...initialProps,
        emotionStyleTags,
      };
    };
    ```

*(Always refer to the latest official MUI documentation for Next.js integration, as patterns can evolve: https://mui.com/material-ui/integrations/nextjs/)*